# Engineering dependability and fault tolerance in a distributed system

* Author: Paddy Byers
* Link: https://www.ably.io/blog/engineering-dependability-and-fault-tolerance-in-a-distributed-system

面向失败做系统设计是架构设计中的一个重要方法，本文详细讨论了分布式系统设计中可靠性与容错的概念，以及实现上的细节。例如，对于无状态服务集群，我们如何评估可靠性。

# 梗概

## 可靠性和容错性

在应用运行过程中，部分依赖可能会出现错误，可靠性和容错性是描述依赖出错后应用是否能继续正常运行。
可靠性和容错性定义：
- Dependability Availability 和 Reliability 是不同纬度的可靠性的描述。
- Availability 指的是独立系统错误时能够提供足够多的资源冗余的评估
- Reliability 指的是系统内存在着错误处理机制的评估。保证系统出现错误时可以持续平稳的运行。
- Fault tolerance 容错性，对于出现错误后系统能正常运行能力的评估。

Availability && Reliability 对于系统可靠性的描述差异
- Availability 描述的是某个时间点可用性的保障，偏向于描述系统整体可用时间，比如经常说的可用性99.9999%。
- Reliability 表示的是系统能够长时间连续正常工作的能力。如果系统每小时宕机1ms，虽然可用性高，但是可靠性并不高。

## 状态
保证 Availability 和 Reliability 的基础在于资源冗余，即提供超过系统最小运行单元的资源总数，当资源出现错误时其他节点可以及时顶上。但是资源冗余的设计在 Availability 和 Reliability表现还是不一致的。
Availability 的设计是允许先将系统停下来，替换冗余元件再继续运行，就像换上备胎然后继续行驶。
Reliability 的设计是保证服务的连续性，冗余元件也需要持续运行着，就像飞机引擎的工作原理。

是否对服务有连续性的需求影响了系统提供冗余容量的方式，在分布式系统中将组件分为无状态和有状态两种：
- 无状态组件内部没有依赖性也没有长期存在的状态，被调用时可以独立于之前的调用状态运行。容错性设计相对简单，拥有足够多的资源，以便于响应。用于提升 Availability

- 有状态组件表示系统本身运行着带有依赖关系的状态。状态过程会把调用链接到一个有状态的阶段，原理和飞机引擎一致。通俗来讲就是运行状态和实际的应用节点一致，从而达到快速替换的目的。主要用于提升 Reliability

## 失败很常规
容错性处理就应该把错误当成一个常规事件来处理，在生产环节任何时间点出现任何错误都不为奇。

同时在容器运行的数字世界里出现的错误可能是非二元的，很多故障信息是无法被识别并处理的。识别这些故障需要额外付出很多工作，有时候还需要人为干预。将故障提前进行识别归类，这样出错时可以识别和归类，这样才可以快速修复。此外进行有规划的测试和系统设计，也可能避免这种问题。总之，容错性设计的挑战在于，如何在部分故障和间歇性故障的时候为用户提供稳定、可持续的服务。


## 无状态服务
无状态服务有以下特性
1. 无状态服务不依赖任何能够持续稳定提供服务的组件，单一资源的可用性就被扩展为层的可用性。
2. 无状态服务中的要求组件的独立性很强，以保证系统的问题运行。这样做的好处是不仅能提高稳定性，也便于伸缩扩容。

无状态服务仅仅是只提供资源冗余是不够的，还需要考虑，如何在不同的错误中持续提供服务以及冗余量的设计和维护成本。也就是说，需要在用户对稳定性的需求、成本、现实可用性中进行协调。
除此之外，在多个地区提供静态服务可以有效保障可用性，这样可以有效的避免因为整个区域的服务都挂掉导致其服务不可用。

## 有状态服务
有状态服务有以下特性
1. 有状态服务对于每个独立请求都有内在依赖，它保证了整层服务的持续可用性和正确性。
2. 它的冗余需要被设计为持续可用避免丢失运行状态，因此冗余组件需要和正常组件一样运行提供服务。

## 可靠性架构设计
- Stateful role placement，伸缩扩容对于无状态应用来说是比较简单的，因为无需考虑组件运行的位置。但是对于有状态的应用而言，需要考虑应用的访问位置。一致性hash可以保证即使节点出错，服务依旧可以被引导到与之前节点状态一致的服务上。
- Detect, hash, resume，检测到错误之后，需要及时将节点重新hash并分配的新的冗余资源上。同时应用运行时，需要有足够的冗余保证状态持续运行。
- Channel persistence layer 从不同的AZs替换冗余组件，保证错误的独立性。






